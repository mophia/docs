---
title: 27数据库其它调优策略
---

## 1. 数据库调优的措施

## 2. 优化MySQL服务器

## 3. 优化数据库结构

### 3.1 拆分表:冷热数据分离

拆分表的思路是，把1个包含很多宇段的表拆分成2个或者多个相对较小的表，这样做的原因是，这些表中某些字段的操作频率很高（热数据），经常要进行查询或者更新操作，而另外一些字段的使用频率却很低 （冷数据），冷热数据分离，可以减小表的宽度。如果放在一个表里面，每次查询都要读取大记录，会消耗较多的资源。

MysQL限制每个表最多存储4096列，并且每一行数据的大小不能超过 65535字节。表越宽，把表装载进内存缓沖池时所占用的内存也就越大，也会消耗更多的I0。冷热数据分离的目的 是：

① 减少磁盘10，保证热数据的内存缓存命中率。

②更有效的利用缓存，避免读入无用的冷数据。

### 3.2 增加中间表

对于需要经常联合查询的表，可以建立中间表以提高查询效率。通过建立中间表，把需要经常联合查询的数据插入中间表中，然后将原来的联合查询改为对中问表的查询，以此来提高查询效率。
首先，分析经常联合查询表中的宇段；然后，使用这些字段建立一个中间表，并将原来联合查询的表的数据插入中间表中；最后，使用中间表来进行直询。

### 3.3 增加冗余字段

设计数据库表时应尽量遵循范式理论的规约，尽可能减少冗余字段，让数据库设计看起来精致、优雅。但是，合理地加入冗余字段可以提高查询速度。

表的规范化程度越高，表与表之间的关系就越多，需要连接查询的情况也就越多。尤其在数据量大，而且需要频繁进行连接的时候，为了提升效率，我们也可以考虑增加冗余字段来减少连接。

### 3.4 优化数据类型

### 3.5 优化插入记录的速度

**1. MyISAM引擎的表:**

1 禁用索引

2 禁用唯一性检查 

3 使用批量插入

4 使用LOAD DATA INFILE 批量导入

**2. InnoDB引擎的表:**

1 禁用唯一性检查 

2 禁用外键检查

3 禁止自动提交

**3.6 使用非空约束**

**在设计字段的时候，如果业务允许，建议尽量使用非空约束**

- 进行比较和计算时，省去要对NULL值的字段判断是否为空的开销，提高仔储效率。
- 非空宇段也容易创建索引。因为索引INULL列需要额外的空问来保存，所以要占用更多的空间。使用非空约
  束，就可以节省存储空间（每个字段1个bit)

### 3.7 分析表、检查表与优化表

**1. 分析表**

MySQL中提供了ANALYZE TABLE语句分析表，ANALYZE TABLE语句的基本语法如下:

```
ANALYZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name[,tbl_name]...
```

默认的，MySQL服务会将 ANALYZE TABLE语句写到binlog中，以便在主从架构中，从服务能够同步数据。可以添加参数LOCAL 或者 NO_WRITE_TO_BINLOG取消将语句写到binlog中。

使用 ANALYZE TABLE 分析表的过程中，数据库系统会自动对表加一个 只读锁 。在分析期间，只能读取 表中的记录，不能更新和插入记录。ANALYZE TABLE语句能够分析InnoDB和MyISAM类型的表，但是不能 作用于视图。

ANALYZE TABLE分析后的统计结果会反应到  的值，该值统计了表中某一键所在的列不重复 的值的个数。 该值越接近表中的总行数，则在表连接查询或者索引查询时，就越优先被优化器选择使 用。 也就是索引列的cardinality的值与表中数据的总条数差距越大，即使查询的时候使用了该索引作为查 询条件，存储引擎实际查询的时候使用的概率就越小。下面通过例子来验证下。cardinality可以通过 SHOW INDEX FROM 表名查看。

**2. 检查表**

MySQL中可以使用CHECK TABLE语句来检查表。CHECKTABLE语句能够检查InnoDB和MyISAM类型的表是否存在错误。CHECK TABLE语句在执行过程中也会给表加上 只读锁 。

对于MyISAM类型的表，CHECK TABLE语句还会更新关键字统计数据。而且，CHECK TABLE也可以检查视图是否有错误，比如在视图定义中被引用的表已不存在。该语句的基本语法如下:

```
 CHECK TABLE tbl_name [, tbl_name] ... [option] ...
option = {QUICK | FAST | MEDIUM | EXTENDED | CHANGED}
```

其中，tbl_name是表名;option参数有5个取值，分别是QUICK、FAST、MEDIUM、EXTENDED和 CHANGED。各个选项的意义分别是:

- QUICK :不扫描行，不检查错误的连接。
- FAST :只检查没有被正确关闭的表。
-  changed    :只检查上次检查后被更改的表和没有被正确关闭的表。
- Medium   :扫描行，以验证被删除的连接是有效的。也可以计算各行的关键字校验和，并使用计算出的校验和验证这一点。
- EXTENDED:对每行的所有关键字进行一个全面的关键字查找。这可以确保表是100%一致的，但是花的时间较长。

**option只对MyISAM类型的表有效，对InnoDB类型的表无效。比如:**

**3. 优化表**

方式1:OPTIMIZE TABLE

MySQL中使用OPTIMIZE TABLE语句来优化表。但是，OPTILMIZETABLE语句只能优化表中的VARCHAR 、 BLOB 或 TEXT 类型的字段。一个表使用了这些字段的数据类型，若已经 删除 了表的一大部分数据，或者已经对含有可变长度行的表(含有VARCHAR、BLOB或TEXT列的表)进行了很多 更新 ，则 应使用OPTIMIZE TABLE来重新利用未使用的空间，并整理数据文件的 碎片 。

OPTIMIZE TABLE 语句对InnoDB和MyISAM类型的表都有效。该语句在执行过程中也会给表加上 只读锁 。OPTILMIZE TABLE语句的基本语法如下:

```
OPTIMIZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name] ...
```

LOCAL | NO_WRITE_TO_BINLOG关键字的意义和分析表相同，都是指定不写入二进制日志。

![](https://cdn.jsdelivr.net/gh/clxmm/image@main/img/2022/03/20220313214039mysql.png)

执行完毕，Msg_text显示

‘numysql.SYS_APP_USER’, ‘optimize’, ‘note’, ‘Table does not support optimize, doing recreate + analyze instead’

原因是我服务器上的MySQL是InnoDB存储引擎。 到底优化了没有呢?看官网!

https://dev.mysql.com/doc/refman/8.0/en/optimize-table.html

在MyISAM中，是先分析这张表，然后会整理相关的MySQL datafile，之后回收未使用的空间;在InnoDB 中，回收空间是简单通过Alter table进行整理空间。在优化期间，MySQL会创建一个临时表，优化完成之 后会删除原始表，然后会将临时表rename成为原始表。

> 说明: 在多数的设置中，根本不需要运行OPTIMIZE TABLE。即使对可变长度的行进行了大量的更 新，也不需要经常运行， 每周一次 或 每月一次 即可，并且只需要对 特定的表 运行。



## 4. 大表优化



### 4.1 限定查询的范围

禁止不带任何限制数据范围条件的查询语句。 比如:我们当用户在查询订单历史的时候，我们可以控制 在一个月的范围内;

### 4.2 读/写分离

经典的数据库拆分方案，主库负责写，从库负责读。

- 一主一从模式:

![](https://cdn.jsdelivr.net/gh/clxmm/image@main/img/2022/03/20220315194331mysql.png)

- 双主双从模式:

![](https://cdn.jsdelivr.net/gh/clxmm/image@main/img/2022/03/20220315194418mysql.png)

### 4.3 垂直拆分

当数据量级达到 千万级 以上时，有时候我们需要把一个数据库切成多份，放到不同的数据库服务器上， 减少对单一数据库服务器的访问压力

![](https://cdn.jsdelivr.net/gh/clxmm/image@main/img/2022/03/20220315194512mysql.png)

- 如果数据库中的数据表过多，可以采用 垂直分库 的方式，将关联的数据表部署在同一个数据库上。
- 如果数据表中的列过多，可以采用 垂直分表 的方式，将一张数据表分拆成多张数据表，把经常一起使用的列
  放到同一张表里。

- 垂直拆分的优点: 可以使得列数据变小，在查询时减少读取的Block数，减少I/O次数。此外，垂直分区可以简化表的结构，易于维护。
- 垂直拆分的缺点: 主键会出现冗余，需要管理冗余列，并会引起 JOIN 操作。此外，垂直拆分会让事务变得更加复杂。

### 4.4 水平拆分

![](https://cdn.jsdelivr.net/gh/clxmm/image@main/img/2022/03/20220315194841mysql.png)

## 5. 其它调优策略

### 5.1 服务器语句超时处理

在MySQL 8.0中可以设置 服务器语句超时的限制 ，单位可以达到 毫秒级别 。当中断的执行语句超过设置的 毫秒数后，服务器将终止查询影响不大的事务或连接，然后将错误报给客户端。

设置服务器语句超时的限制，可以通过设置系统变量 MAX_EXECUTION_TIME 来实现。默认情况下， MAX_EXECUTION_TIME的值为0，代表没有时间限制。 例如:

```sql
SET GLOBAL MAX_EXECUTION_TIME=2000;
SET SESSION MAX_EXECUTION_TIME=2000; #指定该会话中SELECT语句的超时时间
```

